name: Bootstrap Plan

on:
  push:
    branches: [ "main" ]
    paths:   [ "Bootstrap/**" ]
  pull_request:
    paths:   [ "Bootstrap/**" ]
  workflow_dispatch: 
    inputs:
      force_upload:
        description: "Upload tfplan even if there no changes"
        required: false 
        type: boolean
        default: false


permissions:
  id-token: write
  contents: read

concurrency:
  group: bootstrap-plan
  cancel-in-progress: true

defaults:
  run:
    working-directory: ./Bootstrap

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Debug GitHub claims
        run: |
          echo "GITHUB_REPOSITORY     = $GITHUB_REPOSITORY"
          echo "GITHUB_REPOSITORY_ID  = $GITHUB_REPOSITORY_ID"
          echo "GITHUB_REF            = $GITHUB_REF"

      - name: Auth to GCP via WIF
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account:           ${{ secrets.TF_SA_EMAIL }}

      - name: Debug ADC
        run: gcloud auth application-default print-access-token >/dev/null && echo "ADC OK"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Terraform Init
        run: terraform init -input=false

      # 0 = sin cambios, 2 = hay cambios, 1 = error
      - name: Terraform Plan (detailed exit code)
        id: plan
        shell: bash
        run: |
          set +e
          terraform plan -input=false -lock-timeout=3m -out=tfplan -detailed-exitcode
          ec=$?
          echo "exitcode=$ec" >> "$GITHUB_OUTPUT"
          if [ "$ec" -eq 2 ]; then
            echo "changed=true"  >> "$GITHUB_OUTPUT"
            exit 0
          elif [ "$ec" -eq 0 ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          else
            exit "$ec"
          fi

      - name: Echo changed (debug)
        run: echo "changed=${{ steps.plan.outputs.changed }} exitcode=${{ steps.plan.outputs.exitcode }}"

      - name: Guard: only allow specific users to force
        if: ${{ inputs.force_upload == true && !contains('S4M73l09', github.actor) }}
        run: |
          echo "No estas autorizado para usar force_upload (actor=${GITHUB_ACTOR})"
          exit 1


      - name: Debug force flag
        run: |
          echo "force_upload=${{ inputs.force_upload }} | changed=${{ steps.plan.outputs.changed }} | exitcode=${{ steps.plan.outputs.exitcode }}"
          {
            echo "### Plan debug";
            echo "- force_upload: **${{ inputs.force_upload}}**";
            echo "- changed: **${{ steps.plan.outputs.changed }}**";
            echo "- exitcode: **${{ steps.plan.outputs.exitcode }}**";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload tfplan artifact
        if: ${{ steps.plan.outputs.changed == 'true' || inputs.force_upload == true }}
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: ${{ github.workspace }}/Bootstrap/tfplan
          retention-days: 3

      # Opcional: artefacto de texto legible
      - name: Render plan to text (always)
        if: steps.plan.outputs.changed == 'true'
        run: terraform show -no-color tfplan > plan.txt || echo "No tfplan file" > plan.txt

      - name: Upload plan.txt (always)
        if: steps.plan.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: plan.txt
          path: ${{ github.workspace }}/Bootstrap/plan.txt
          retention-days: 14



